filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Educación:", n_dupli_educ))
# 4. SERVICIOS DEL HOGAR
n_dupli_servicios <- df_servicios %>%
group_by(DIRECTORIO, SECUENCIA_P) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Servicios:", n_dupli_servicios))
# 5. VIVIENDA
n_dupli_vivienda <- df_vivienda %>%
group_by(DIRECTORIO) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Vivienda:", n_dupli_vivienda))
#//////// Se unen las 5 bases
df_final <- df_salud %>%
# Join 1: Nivel Persona con Persona (Match perfecto)
left_join(df_caracteristicas, by = c("DIRECTORIO", "SECUENCIA_P", "ORDEN")) %>%
# Join 2: Nivel Persona con Persona (Match perfecto)
left_join(df_educacion,       by = c("DIRECTORIO", "SECUENCIA_P", "ORDEN")) %>%
# Join 3: Nivel Persona con Hogar (Muchos a Uno)
left_join(df_servicios,       by = c("DIRECTORIO", "SECUENCIA_P")) %>%
# Join 4: Nivel Persona con Vivienda (Muchos a Uno)
left_join(df_vivienda,        by = c("DIRECTORIO"))
# revisión general y de los mising
skimr::skim(df_final)
#//////// Renombramiento y limpieza final de variables
df_final <- df_final %>%
rename(
# --- Variable Dependiente ---
# P1930: ¿Diagnóstico de enfermedad crónica en últimos 12 meses?
cronica_12m = P1930,
# --- Variable Independiente ---
# P1707: ¿Consume bebidas azucaradas?
consume_azucar = P1707,
# P1707S1: Frecuencia de consumo
frecuencia_azucar = P1707S1,
# --- Variables de Control (Sociodemográficas) ---
# P6020: Sexo
sexo = P6020,
# P6040: Edad
edad = P6040,
# P6051: Parentesco con jefe de hogar
parentesco = P6051,
# P8587: Nivel educativo más alto
nivel_educativo = P8587,
# Geografía
cod_depto = P1_DEPARTAMENTO,
cod_mpio  = P1_MUNICIPIO,
# Economía del hogar
ingreso_pc = PERCAPITA,
# Factor de expansión (Peso muestral)
fex = FEX_C
) %>%
# janitor::clean_names() convierte todo lo restante a minúsculas y snake_case
# Ej: DIRECTORIO -> directorio, SECUENCIA_P -> secuencia_p
janitor::clean_names()
# Verificación de los nuevos nombres
skimr::skim(df_final)
# 1. Crear subconjunto solo con NAs en nivel educativo
df_educacion_na <- df_final %>%
filter(is.na(nivel_educativo))
# 2. Verificación rápida: ¿Quiénes son estos individuos?
summary(df_educacion_na$edad)
#//////// Se verifican los duplicados
# 1. SALUD
n_dupli_salud <- df_salud %>%
group_by(DIRECTORIO, SECUENCIA_P, ORDEN) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Salud:", n_dupli_salud))
# 2. CARACTERÍSTICAS
n_dupli_caract <- df_caracteristicas %>%
group_by(DIRECTORIO, SECUENCIA_P, ORDEN) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Características:", n_dupli_caract))
# 3. EDUCACIÓN
n_dupli_educ <- df_educacion %>%
group_by(DIRECTORIO, SECUENCIA_P, ORDEN) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Educación:", n_dupli_educ))
# 4. SERVICIOS DEL HOGAR
n_dupli_servicios <- df_servicios %>%
group_by(DIRECTORIO, SECUENCIA_P) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Servicios:", n_dupli_servicios))
# 4. SERVICIOS DEL HOGAR
n_dupli_servicios <- df_servicios %>%
group_by(DIRECTORIO, SECUENCIA_P) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Servicios:", n_dupli_servicios))
# Corrección eliminando duplicados
df_servicios <- df_servicios %>%
group_by(DIRECTORIO, SECUENCIA_P) %>%
slice_head(n = 1) %>%
ungroup()
# Verificar de nuevo
n_dupli_servicios_post <- df_servicios %>%
group_by(DIRECTORIO, SECUENCIA_P) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Servicios después de corregir:", n_dupli_servicios_post))
# 5. VIVIENDA
n_dupli_vivienda <- df_vivienda %>%
group_by(DIRECTORIO) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Vivienda:", n_dupli_vivienda))
#//////// Mantener solo las variables de interés
# 1. Base de Salud (Nivel Persona)
df_salud <- salud %>%
select(DIRECTORIO, SECUENCIA_P, ORDEN,
P1707,       # Consumo bebidas azucaradas
P1707S1,     # Frecuencia consumo
P1930)       # Diagnóstico enfermedad crónica
# 2. Base de Características del Hogar (Nivel Persona)
df_caracteristicas <- caracteristicas %>%
select(DIRECTORIO, SECUENCIA_P, ORDEN, FEX_C,
P6020,       # Sexo
P6040,       # Edad
P6051)       # Jefe del hogar
# 3. Base de Educación (Nivel Persona)
df_educacion <- educacion %>%
select(DIRECTORIO, SECUENCIA_P, ORDEN,
P8587)       # Variable nivel educativo
# 4. Base de Servicios del Hogar (Nivel Hogar)
df_servicios <- servicios %>%
select(DIRECTORIO,
SECUENCIA_P,
PERCAPITA   # Ingreso per cápita - REVISAR EN EQUIPO
)
# 5. Base de Datos de la Vivienda (Nivel Vivienda)
df_vivienda <- vivienda %>%
select(DIRECTORIO,
P1_DEPARTAMENTO,
P1_MUNICIPIO)
#//////// Se verifican los duplicados
# 1. SALUD
n_dupli_salud <- df_salud %>%
group_by(DIRECTORIO, SECUENCIA_P, ORDEN) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Salud:", n_dupli_salud))
# 2. CARACTERÍSTICAS
n_dupli_caract <- df_caracteristicas %>%
group_by(DIRECTORIO, SECUENCIA_P, ORDEN) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Características:", n_dupli_caract))
# 3. EDUCACIÓN
n_dupli_educ <- df_educacion %>%
group_by(DIRECTORIO, SECUENCIA_P, ORDEN) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Educación:", n_dupli_educ))
# 4. SERVICIOS DEL HOGAR
n_dupli_servicios <- df_servicios %>%
group_by(DIRECTORIO, SECUENCIA_P) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Servicios:", n_dupli_servicios))
# 4. SERVICIOS DEL HOGAR
n_dupli_servicios <- df_servicios %>%
group_by(DIRECTORIO, SECUENCIA_P) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Servicios:", n_dupli_servicios))
# Corrección eliminando duplicados
df_servicios <- df_servicios %>%
group_by(DIRECTORIO, SECUENCIA_P) %>%
slice_head(n = 1) %>%
ungroup()
# Verificar de nuevo
n_dupli_servicios_post <- df_servicios %>%
group_by(DIRECTORIO, SECUENCIA_P) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Servicios después de corregir:", n_dupli_servicios_post))
# 5. VIVIENDA
n_dupli_vivienda <- df_vivienda %>%
group_by(DIRECTORIO) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Vivienda:", n_dupli_vivienda))
#//////// Se verifican los duplicados
# 1. SALUD
n_dupli_salud <- df_salud %>%
group_by(DIRECTORIO, SECUENCIA_P, ORDEN) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Salud:", n_dupli_salud))
# 2. CARACTERÍSTICAS
n_dupli_caract <- df_caracteristicas %>%
group_by(DIRECTORIO, SECUENCIA_P, ORDEN) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Características:", n_dupli_caract))
# 3. EDUCACIÓN
n_dupli_educ <- df_educacion %>%
group_by(DIRECTORIO, SECUENCIA_P, ORDEN) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Educación:", n_dupli_educ))
# 4. SERVICIOS DEL HOGAR
n_dupli_servicios <- df_servicios %>%
group_by(DIRECTORIO, SECUENCIA_P) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Servicios:", n_dupli_servicios))
# Corrección eliminando duplicados
df_servicios <- df_servicios %>%
group_by(DIRECTORIO, SECUENCIA_P) %>%
slice_head(n = 1) %>%
ungroup()
# Verificar de nuevo
n_dupli_servicios_post <- df_servicios %>%
group_by(DIRECTORIO, SECUENCIA_P) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Servicios después de corregir:", n_dupli_servicios_post))
# 5. VIVIENDA
n_dupli_vivienda <- df_vivienda %>%
group_by(DIRECTORIO) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Vivienda:", n_dupli_vivienda))
#//////// Se unen las 5 bases
df_final <- df_salud %>%
# Join 1: Nivel Persona con Persona (Match perfecto)
left_join(df_caracteristicas, by = c("DIRECTORIO", "SECUENCIA_P", "ORDEN")) %>%
# Join 2: Nivel Persona con Persona (Match perfecto)
left_join(df_educacion,       by = c("DIRECTORIO", "SECUENCIA_P", "ORDEN")) %>%
# Join 3: Nivel Persona con Hogar (Muchos a Uno)
left_join(df_servicios,       by = c("DIRECTORIO", "SECUENCIA_P")) %>%
# Join 4: Nivel Persona con Vivienda (Muchos a Uno)
left_join(df_vivienda,        by = c("DIRECTORIO"))
# revisión general y de los mising
skimr::skim(df_final)
#//////// Renombramiento y limpieza final de variables
df_final <- df_final %>%
rename(
# --- Variable Dependiente ---
# P1930: ¿Diagnóstico de enfermedad crónica en últimos 12 meses?
cronica_12m = P1930,
# --- Variable Independiente ---
# P1707: ¿Consume bebidas azucaradas?
consume_azucar = P1707,
# P1707S1: Frecuencia de consumo
frecuencia_azucar = P1707S1,
# --- Variables de Control (Sociodemográficas) ---
# P6020: Sexo
sexo = P6020,
# P6040: Edad
edad = P6040,
# P6051: Parentesco con jefe de hogar
parentesco = P6051,
# P8587: Nivel educativo más alto
nivel_educativo = P8587,
# Geografía
cod_depto = P1_DEPARTAMENTO,
cod_mpio  = P1_MUNICIPIO,
# Economía del hogar
ingreso_pc = PERCAPITA,
# Factor de expansión (Peso muestral)
fex = FEX_C
) %>%
janitor::clean_names()
# Verificación de los nuevos nombres
skimr::skim(df_final)
View(df_final)
#//////// Renombramiento y limpieza final de variables
df_final <- df_final %>%
rename(
# --- Variable Dependiente ---
# P1930: ¿Diagnóstico de enfermedad crónica en últimos 12 meses?
cronica_12m = P1930,
# --- Variable Independiente ---
# P1707: ¿Consume bebidas azucaradas?
consume_azucar = P1707,
# P1707S1: Frecuencia de consumo
frecuencia_azucar = P1707S1,
# --- Variables de Control (Sociodemográficas) ---
# P6020: Sexo
sexo = P6020,
# P6040: Edad
edad = P6040,
# P6051: Parentesco con jefe de hogar
parentesco = P6051,
# P8587: Nivel educativo más alto
nivel_educativo = P8587,
# Geografía
cod_depto = P1_DEPARTAMENTO,
cod_mpio  = P1_MUNICIPIO,
# Economía del hogar
ingreso_pc = PERCAPITA,
# Factor de expansión (Peso muestral)
fex = FEX_C
) %>%
janitor::clean_names()
# Instalando pacman si se requier
if (!require("pacman")) install.packages("pacman")
# Cargando los paquetes usando pacman
pacman::p_load(
# A) Manipulación, limpieza y visualización de datos
tidyverse,    # Colección de paquetes esenciales (incluye dplyr, ggplot2, etc.)
forcats,      # Herramientas para trabajar con variables categóricas (factores).
tibble,       # Implementación moderna de data.frames.
janitor,      # Limpieza de nombres de variables y tablas de frecuencia.
lubridate,    # Manejo avanzado de fechas y horas.
skimr,        # Resúmenes estadísticos completos y rápidos de data.frames.
stringi,      # Manipulación robusta de texto (strings).
scales,       # Formato de escalas en ggplot2 (ej. porcentajes, comas).
openxlsx,     # Guardar excel
writexl,      # Guardar excel
haven,
# B) Modelado y análisis estadístico/econométrico
fixest,       # Estimación de modelos de efectos fijos de alto rendimiento.
plm,          # Modelos econométricos para datos de panel.
AER,          # Herramientas para econometría aplicada (ej. variables instrumentales).
lmtest,       # Pruebas de hipótesis para modelos de regresión (ej. coeftest).
sandwich,     # Cálculo de errores estándar robustos a heterocedasticidad.
survey,       # Análisis de datos de encuestas complejas (ponderación, estratificación).
# C) Importación, exportación y generación de reportes
haven,        # Lectura y escritura de formatos de Stata, SAS y SPSS.
readxl,       # Lectura de archivos de Excel (.xls y .xlsx).
stargazer,    # Creación de tablas de regresión con formato de publicación.
knitr         # Generación de reportes dinámicos.
)
#//////// Rutas y datos iniciales de las 4 bases
#getwd()
ruta <- "C:/1. MECA/2025/EXPLORACIÓN Y VISUALIZACIÓN DE DATOS- Miguel Andres Garzón/Datos_proyecto2"
# Base 1: Salud
salud <- read_dta(file.path(ruta, "Salud.dta"))
# Base 2: Características y composición del hogar
caracteristicas <- read_dta(file.path(ruta, "Características y composición del hogar.dta"))
# Base 3: Educación
educacion <- read_dta(file.path(ruta, "Educación.dta"))
# Base 4: Servicios del hogar
servicios <- read_dta(file.path(ruta, "Servicios del hogar.dta"))
# Base 5: Datos de la vivienda
vivienda <- read_dta(file.path(ruta, "Datos de la vivienda.dta"))
# Revisión de las bases
#str(salud)        # tipo de variables
#//////// Mantener solo las variables de interés
# 1. Base de Salud (Nivel Persona)
df_salud <- salud %>%
select(DIRECTORIO, SECUENCIA_P, ORDEN,
P1707,       # Consumo bebidas azucaradas
P1707S1,     # Frecuencia consumo
P1930)       # Diagnóstico enfermedad crónica
# 2. Base de Características del Hogar (Nivel Persona)
df_caracteristicas <- caracteristicas %>%
select(DIRECTORIO, SECUENCIA_P, ORDEN, FEX_C,
P6020,       # Sexo
P6040,       # Edad
P6051)       # Jefe del hogar
# 3. Base de Educación (Nivel Persona)
df_educacion <- educacion %>%
select(DIRECTORIO, SECUENCIA_P, ORDEN,
P8587)       # Variable nivel educativo
# 4. Base de Servicios del Hogar (Nivel Hogar)
df_servicios <- servicios %>%
select(DIRECTORIO,
SECUENCIA_P,
PERCAPITA   # Ingreso per cápita - REVISAR EN EQUIPO
)
# 5. Base de Datos de la Vivienda (Nivel Vivienda)
df_vivienda <- vivienda %>%
select(DIRECTORIO,
P1_DEPARTAMENTO,
P1_MUNICIPIO)
#//////// Se verifican los duplicados
# 1. SALUD
n_dupli_salud <- df_salud %>%
group_by(DIRECTORIO, SECUENCIA_P, ORDEN) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Salud:", n_dupli_salud))
# 2. CARACTERÍSTICAS
n_dupli_caract <- df_caracteristicas %>%
group_by(DIRECTORIO, SECUENCIA_P, ORDEN) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Características:", n_dupli_caract))
# 3. EDUCACIÓN
n_dupli_educ <- df_educacion %>%
group_by(DIRECTORIO, SECUENCIA_P, ORDEN) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Educación:", n_dupli_educ))
# 4. SERVICIOS DEL HOGAR
n_dupli_servicios <- df_servicios %>%
group_by(DIRECTORIO, SECUENCIA_P) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Servicios:", n_dupli_servicios))
# Corrección eliminando duplicados
df_servicios <- df_servicios %>%
group_by(DIRECTORIO, SECUENCIA_P) %>%
slice_head(n = 1) %>%
ungroup()
# Verificar de nuevo
n_dupli_servicios_post <- df_servicios %>%
group_by(DIRECTORIO, SECUENCIA_P) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Servicios después de corregir:", n_dupli_servicios_post))
# 5. VIVIENDA
n_dupli_vivienda <- df_vivienda %>%
group_by(DIRECTORIO) %>%
filter(n() > 1) %>%
nrow()
print(paste("Duplicados en Vivienda:", n_dupli_vivienda))
#//////// Se unen las 5 bases
df_final <- df_salud %>%
# Join 1: Nivel Persona con Persona (Match perfecto)
left_join(df_caracteristicas, by = c("DIRECTORIO", "SECUENCIA_P", "ORDEN")) %>%
# Join 2: Nivel Persona con Persona (Match perfecto)
left_join(df_educacion,       by = c("DIRECTORIO", "SECUENCIA_P", "ORDEN")) %>%
# Join 3: Nivel Persona con Hogar (Muchos a Uno)
left_join(df_servicios,       by = c("DIRECTORIO", "SECUENCIA_P")) %>%
# Join 4: Nivel Persona con Vivienda (Muchos a Uno)
left_join(df_vivienda,        by = c("DIRECTORIO"))
# revisión general y de los mising
skimr::skim(df_final)
#//////// Renombramiento y limpieza final de variables
df_final <- df_final %>%
rename(
# --- Variable Dependiente ---
# P1930: ¿Diagnóstico de enfermedad crónica en últimos 12 meses?
cronica_12m = P1930,
# --- Variable Independiente ---
# P1707: ¿Consume bebidas azucaradas?
consume_azucar = P1707,
# P1707S1: Frecuencia de consumo
frecuencia_azucar = P1707S1,
# --- Variables de Control (Sociodemográficas) ---
# P6020: Sexo
sexo = P6020,
# P6040: Edad
edad = P6040,
# P6051: Parentesco con jefe de hogar
parentesco = P6051,
# P8587: Nivel educativo más alto
nivel_educativo = P8587,
# Geografía
cod_depto = P1_DEPARTAMENTO,
cod_mpio  = P1_MUNICIPIO,
# Economía del hogar
ingreso_pc = PERCAPITA,
# Factor de expansión (Peso muestral)
fex = FEX_C
) %>%
janitor::clean_names()
# Verificación de los nuevos nombres
skimr::skim(df_final)
str(df_final)
# Tabla resumen estadísticas para conocer la base
# 1. Crear tabla resumen
tabla_resumen <- df_final %>%
summarise(across(everything(), list(
tipo = ~ class(.x)[1],
na = ~ sum(is.na(.x)),
na_porc = ~ mean(is.na(.x)) * 100,
min = ~ if(is.numeric(.x)) min(.x, na.rm = TRUE) else NA,
max = ~ if(is.numeric(.x)) max(.x, na.rm = TRUE) else NA,
media = ~ if(is.numeric(.x)) mean(.x, na.rm = TRUE) else NA,
mediana = ~ if(is.numeric(.x)) median(.x, na.rm = TRUE) else NA,
n_categorias = ~ if(!is.numeric(.x)) length(unique(.x)) else NA
))) %>%
pivot_longer(cols = everything(),
names_to = c("variable", "estadistica"),
names_sep = "_",
values_to = "valor") %>%
pivot_wider(names_from = estadistica, values_from = valor)
# Tabla resumen estadísticas para conocer la base
library(dplyr)
library(tidyr)
library(kableExtra)
#-------------------------------------------
# 1. Crear tabla resumen SIN FUNCIONES
#-------------------------------------------
tabla_resumen <- df_final %>%
summarise(across(
everything(),
list(
tipo = ~ class(.x)[1],
na = ~ sum(is.na(.x)),
na_porc = ~ mean(is.na(.x)) * 100,
min = ~ if (is.numeric(.x)) min(.x, na.rm = TRUE) else NA,
max = ~ if (is.numeric(.x)) max(.x, na.rm = TRUE) else NA,
media = ~ if (is.numeric(.x)) mean(.x, na.rm = TRUE) else NA,
mediana = ~ if (is.numeric(.x)) median(.x, na.rm = TRUE) else NA,
n_categorias = ~ if (!is.numeric(.x)) length(unique(.x)) else NA
),
.names = "{col}__{fn}"   # ← CLAVE PARA EVITAR ERRORES
)) %>%
pivot_longer(
cols = everything(),
names_to = c("variable", "estadistica"),
names_sep = "__",        # ← SEPARADOR CONSISTENTE
values_to = "valor"
) %>%
pivot_wider(
names_from = estadistica,
values_from = valor
)
