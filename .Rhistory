coord_flip()
print(univariado_grupo_edad)
# Guardar gráfico
ggsave("Graficos-tablas/univariado_grupo_edad.png",
univariado_grupo_edad,
width = 8,
height = 6)
library(dplyr)
library(ggplot2)
library(tidyr)
library(scales)
# =========================================================
# 1. TABLA DE ESTADÍSTICOS UNIVARIADOS
# =========================================================
tabla_edad <- df_analisis %>%
summarise(
n_no_pond = n(),
media_no_pond = mean(edad, na.rm = TRUE),
sd_no_pond = sd(edad, na.rm = TRUE),
mediana_no_pond = median(edad, na.rm = TRUE),
q25 = quantile(edad, 0.25, na.rm = TRUE),
q75 = quantile(edad, 0.75, na.rm = TRUE),
RIQ_no_pond = q75 - q25,
min_no_pond = min(edad, na.rm = TRUE),
max_no_pond = max(edad, na.rm = TRUE)
)
# Estadísticos ponderados usando fex
tabla_edad_pond <- df_analisis %>%
summarise(
n_pond = sum(fex, na.rm = TRUE),
media_pond = weighted.mean(edad, w = fex, na.rm = TRUE),
sd_pond = sqrt(sum(fex * (edad - weighted.mean(edad, w = fex, na.rm = TRUE))^2) / sum(fex, na.rm = TRUE)),
mediana_pond = weighted.median(edad, w = fex, na.rm = TRUE),
q25_pond = Hmisc::wtd.quantile(edad, weights = fex, probs = 0.25, na.rm = TRUE),
q75_pond = Hmisc::wtd.quantile(edad, weights = fex, probs = 0.75, na.rm = TRUE),
RIQ_pond = q75_pond - q25_pond,
min_pond = min(edad, na.rm = TRUE),
max_pond = max(edad, na.rm = TRUE)
)
# -----------------
# Estadísticos No Ponderados
# -----------------
stats_no_pond <- df_analisis %>%
summarise(
N_obs = n(),
Media = mean(edad, na.rm = TRUE),
DS = sd(edad, na.rm = TRUE),
Q25 = quantile(edad, 0.25, na.rm = TRUE),
Mediana = quantile(edad, 0.50, na.rm = TRUE),
Q75 = quantile(edad, 0.75, na.rm = TRUE),
RIQ = Q75 - Q25,
Min = min(edad, na.rm = TRUE),
Max = max(edad, na.rm = TRUE)
) %>%
mutate(Tipo = "No ponderado")
# -----------------
# Estadísticos Ponderados
# -----------------
# Limpieza de datos (por si hay NAs en edad o fex)
data_clean <- df_analisis %>% filter(!is.na(edad) & !is.na(fex))
# Cálculo de la media ponderada (necesaria para el cálculo de la DS ponderada)
weighted_mean_edad <- weighted.mean(data_clean$edad, w = data_clean$fex, na.rm = TRUE)
# Cálculo de cuantiles ponderados
quantiles_pond <- wtd.quantile(data_clean$edad, weights = data_clean$fex, probs = c(0.25, 0.5, 0.75), na.rm = TRUE)
# Instalando pacman si se requier
if (!require("pacman")) install.packages("pacman")
# Cargando los paquetes usando pacman
pacman::p_load(
# A) Manipulación, limpieza y visualización de datos
tidyverse,    # Colección de paquetes esenciales (incluye dplyr, ggplot2, etc.)
forcats,      # Herramientas para trabajar con variables categóricas (factores).
tibble,       # Implementación moderna de data.frames.
janitor,      # Limpieza de nombres de variables y tablas de frecuencia.
lubridate,    # Manejo avanzado de fechas y horas.
skimr,        # Resúmenes estadísticos completos y rápidos de data.frames.
stringi,      # Manipulación robusta de texto (strings).
scales,       # Formato de escalas en ggplot2 (ej. porcentajes, comas).
openxlsx,     # Guardar excel
writexl,      # Guardar excel
here,
haven,
kableExtra,
paletteer,
ggplot2,
ggthemes,
broom,
stringr,
gt,
webshot2,
Hmisc,
# B) Modelado y análisis estadístico/econométrico
fixest,       # Estimación de modelos de efectos fijos de alto rendimiento.
plm,          # Modelos econométricos para datos de panel.
AER,          # Herramientas para econometría aplicada (ej. variables instrumentales).
lmtest,       # Pruebas de hipótesis para modelos de regresión (ej. coeftest).
sandwich,     # Cálculo de errores estándar robustos a heterocedasticidad.
survey,       # Análisis de datos de encuestas complejas (ponderación, estratificación).
# C) Importación, exportación y generación de reportes
haven,        # Lectura y escritura de formatos de Stata, SAS y SPSS.
readxl,       # Lectura de archivos de Excel (.xls y .xlsx).
stargazer,    # Creación de tablas de regresión con formato de publicación.
knitr,         # Generación de reportes dinámicos.
writexl
)
# -----------------
# Estadísticos No Ponderados
# -----------------
stats_no_pond <- df_analisis %>%
summarise(
N_obs = n(),
Media = mean(edad, na.rm = TRUE),
DS = sd(edad, na.rm = TRUE),
Q25 = quantile(edad, 0.25, na.rm = TRUE),
Mediana = quantile(edad, 0.50, na.rm = TRUE),
Q75 = quantile(edad, 0.75, na.rm = TRUE),
RIQ = Q75 - Q25,
Min = min(edad, na.rm = TRUE),
Max = max(edad, na.rm = TRUE)
) %>%
mutate(Tipo = "No ponderado")
# -----------------
# Estadísticos Ponderados
# -----------------
# Limpieza de datos (por si hay NAs en edad o fex)
data_clean <- df_analisis %>% filter(!is.na(edad) & !is.na(fex))
# Cálculo de la media ponderada (necesaria para el cálculo de la DS ponderada)
weighted_mean_edad <- weighted.mean(data_clean$edad, w = data_clean$fex, na.rm = TRUE)
# Cálculo de cuantiles ponderados
quantiles_pond <- wtd.quantile(data_clean$edad, weights = data_clean$fex, probs = c(0.25, 0.5, 0.75), na.rm = TRUE)
stats_pond <- data_clean %>%
summarise(
N_obs = sum(fex, na.rm = TRUE), # Suma de pesos
Media = weighted_mean_edad,
# Cálculo directo de la desviación estándar ponderada (DS):
# sqrt( sum(peso * (valor - media_pond)^2) / sum(peso) )
DS = sqrt(sum(fex * (edad - weighted_mean_edad)^2, na.rm = TRUE) / sum(fex, na.rm = TRUE)),
Q25 = quantiles_pond[1],
Mediana = quantiles_pond[2],
Q75 = quantiles_pond[3],
RIQ = Q75 - Q25,
Min = min(edad, na.rm = TRUE),
Max = max(edad, na.rm = TRUE)
) %>%
mutate(Tipo = "Ponderado")
# Combinar y formatear la tabla final para mostrar
tabla_final_edad <- bind_rows(stats_no_pond, stats_pond) %>%
select(Tipo, N_obs, Media, DS, Mediana, RIQ, Min, Max) %>%
# Redondear todas las métricas a 2 decimales, excepto N_obs (que es el conteo o suma de pesos)
mutate(across(c(Media, DS, Mediana, RIQ, Min, Max), ~round(., 2)))
print(tabla_final_edad)
# =========================================================
# 3. GRÁFICO COMPARATIVO: GRÁFICO DE DENSIDAD
# =========================================================
paleta_teal <- c("#0097A7", "#26C6DA") # Verde azulado oscuro y claro
# Uso de geom_density para un "gráfico de densidad" más directo
grafico_densidad_edad <- ggplot() +
# Densidad No ponderada
geom_density(data = df_analisis,
aes(x = edad, color = "No ponderado", fill = "No ponderado"),
alpha = 0.5, linewidth = 1) +
# Densidad Ponderada (usando fex como peso)
geom_density(data = df_analisis,
aes(x = edad, weight = fex, color = "Ponderado", fill = "Ponderado"),
alpha = 0.5, linewidth = 1) +
scale_fill_manual(values = c("No ponderado" = paleta_teal[2], "Ponderado" = paleta_teal[1])) +
scale_color_manual(values = c("No ponderado" = paleta_teal[1], "Ponderado" = paleta_teal[1])) + # Misma línea para mejor contraste
labs(
title = "Distribución de la Edad: No Ponderada vs Ponderada",
x = "Edad",
y = "Densidad",
fill = "Tipo de Medida",
color = "Tipo de Medida",
caption = "Fuente: Elaboración propia. Los pesos (fex) se aplican al cálculo de la densidad ponderada."
) +
theme_minimal(base_size = 14) +
theme(
plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
legend.position = "bottom",
axis.text = element_text(color = "black")
)
print(grafico_densidad_edad)
# -----------------
# Estadísticos No Ponderados
# -----------------
stats_no_pond <- df_analisis %>%
summarise(
N_obs = n(),
Media = mean(edad, na.rm = TRUE),
DS = sd(edad, na.rm = TRUE),
Q25 = quantile(edad, 0.25, na.rm = TRUE),
Mediana = quantile(edad, 0.50, na.rm = TRUE),
Q75 = quantile(edad, 0.75, na.rm = TRUE),
RIQ = Q75 - Q25,
Min = min(edad, na.rm = TRUE),
Max = max(edad, na.rm = TRUE)
) %>%
mutate(Tipo = "No ponderado")
# -----------------
# Estadísticos Ponderados
# -----------------
stats_pond <- df_analisis %>%
summarise(
N_obs = sum(fex, na.rm = TRUE),
Media = weighted.mean(edad, w = fex, na.rm = TRUE),
DS = sqrt(sum(fex * (edad - weighted.mean(edad, w = fex, na.rm = TRUE))^2, na.rm = TRUE) / sum(fex, na.rm = TRUE)),
Q25 = wtd.quantile(edad, weights = fex, probs = 0.25, na.rm = TRUE),
Mediana = wtd.quantile(edad, weights = fex, probs = 0.5, na.rm = TRUE),
Q75 = wtd.quantile(edad, weights = fex, probs = 0.75, na.rm = TRUE),
RIQ = Q75 - Q25,
Min = min(edad, na.rm = TRUE),
Max = max(edad, na.rm = TRUE)
) %>%
mutate(Tipo = "Ponderado")
# -----------------
# Combinar tablas y formatear
# -----------------
tabla_final_edad <- bind_rows(stats_no_pond, stats_pond) %>%
select(Tipo, N_obs, Media, DS, Mediana, RIQ, Min, Max) %>%
mutate(across(c(Media, DS, Mediana, RIQ, Min, Max), ~round(., 2)))
print(tabla_final_edad)
# =========================================================
# Gráfico de densidad comparativo
# =========================================================
paleta_teal <- c("#0097A7", "#26C6DA") # Verde azulado oscuro y claro
grafico_densidad_edad <- ggplot() +
geom_density(data = df_analisis,
aes(x = edad, color = "No ponderado", fill = "No ponderado"),
alpha = 0.5, linewidth = 1) +
geom_density(data = df_analisis,
aes(x = edad, weight = fex, color = "Ponderado", fill = "Ponderado"),
alpha = 0.5, linewidth = 1) +
scale_fill_manual(values = c("No ponderado" = paleta_teal[2], "Ponderado" = paleta_teal[1])) +
scale_color_manual(values = c("No ponderado" = paleta_teal[1], "Ponderado" = paleta_teal[1])) +
labs(
title = "Distribución de la Edad: No Ponderada vs Ponderada",
x = "Edad",
y = "Densidad",
fill = "Tipo de Medida",
color = "Tipo de Medida",
caption = "Fuente: Elaboración propia. Los pesos (fex) se aplican al cálculo de la densidad ponderada."
) +
theme_minimal(base_size = 14) +
theme(
plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
legend.position = "bottom",
axis.text = element_text(color = "black")
)
print(grafico_densidad_edad)
# Guardar gráfico de densidad de edad
ggsave("Graficos-tablas/univariado_edad.png",
grafico_densidad_edad,
width = 8,
height = 6)
# Estadísticos No Ponderados
stats_no_pond <- df_analisis %>%
summarise(
N_obs = n(),
Media = mean(edad, na.rm = TRUE),
DS = sd(edad, na.rm = TRUE),
Q25 = quantile(edad, 0.25, na.rm = TRUE),
Mediana = quantile(edad, 0.50, na.rm = TRUE),
Q75 = quantile(edad, 0.75, na.rm = TRUE),
RIQ = Q75 - Q25,
Min = min(edad, na.rm = TRUE),
Max = max(edad, na.rm = TRUE)
) %>%
mutate(Tipo = "No ponderado")
# Estadísticos Ponderados
stats_pond <- df_analisis %>%
summarise(
N_obs = sum(fex, na.rm = TRUE),
Media = weighted.mean(edad, w = fex, na.rm = TRUE),
DS = sqrt(sum(fex * (edad - weighted.mean(edad, w = fex, na.rm = TRUE))^2, na.rm = TRUE) / sum(fex, na.rm = TRUE)),
Q25 = wtd.quantile(edad, weights = fex, probs = 0.25, na.rm = TRUE),
Mediana = wtd.quantile(edad, weights = fex, probs = 0.5, na.rm = TRUE),
Q75 = wtd.quantile(edad, weights = fex, probs = 0.75, na.rm = TRUE),
RIQ = Q75 - Q25,
Min = min(edad, na.rm = TRUE),
Max = max(edad, na.rm = TRUE)
) %>%
mutate(Tipo = "Ponderado")
# Combinar tablas
tabla_final_edad <- bind_rows(stats_no_pond, stats_pond) %>%
select(Tipo, N_obs, Media, DS, Mediana, RIQ, Min, Max) %>%
mutate(across(c(Media, DS, Mediana, RIQ, Min, Max), ~round(., 2)))
print(tabla_final_edad)
# Gráfico de densidad comparativo
paleta_teal <- c("#0097A7", "#26C6DA")
grafico_densidad_edad <- ggplot() +
geom_density(data = df_analisis,
aes(x = edad, color = "No ponderado", fill = "No ponderado"),
alpha = 0.5, linewidth = 1) +
geom_density(data = df_analisis,
aes(x = edad, weight = fex, color = "Ponderado", fill = "Ponderado"),
alpha = 0.5, linewidth = 1) +
scale_fill_manual(values = c("No ponderado" = paleta_teal[2], "Ponderado" = paleta_teal[1])) +
scale_color_manual(values = c("No ponderado" = paleta_teal[1], "Ponderado" = paleta_teal[1])) +
labs(
title = "Distribución de la Edad: No Ponderada vs Ponderada",
x = "Edad",
y = "Densidad",
fill = "Tipo de Medida",
color = "Tipo de Medida",
caption = "Fuente: Elaboración propia. Los pesos (fex) se aplican al cálculo de la densidad ponderada."
) +
theme_minimal(base_size = 14) +
theme(
plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
legend.position = "bottom",
axis.text = element_text(color = "black")
)
print(grafico_densidad_edad)
# Guardar gráfico
ggsave("Graficos-tablas/univariado_edad.png",
grafico_densidad_edad,
width = 8,
height = 6)
# Cálculo NO Ponderado (Muestra real)
tabla_no_pond_cd <- df_analisis %>%
count(consumo_detallado) %>%
mutate(prop_no_pond = n / sum(n)) %>%
rename(freq_no_pond = n)
# Cálculo Ponderado (Estimación poblacional)
tabla_pond_cd <- df_analisis %>%
group_by(consumo_detallado) %>%
summarise(freq_pond = sum(fex, na.rm = TRUE)) %>%
ungroup() %>%
mutate(prop_pond = freq_pond / sum(freq_pond))
# --- Unir tablas
tabla_final_cd <- tabla_no_pond_cd %>%
left_join(tabla_pond_cd, by = "consumo_detallado")
print(head(tabla_final_cd))
# Gráfico
datos_grafico_cd <- tabla_final_cd %>%
select(consumo_detallado, prop_no_pond, prop_pond) %>%
pivot_longer(
cols = c(prop_no_pond, prop_pond),
names_to = "tipo_medida",
values_to = "proporcion"
) %>%
mutate(
tipo_medida = case_when(
tipo_medida == "prop_no_pond" ~ "Muestra (No Ponderado)",
tipo_medida == "prop_pond" ~ "Población (Ponderado)"
)
)
# Paleta TEAL
paleta_teal <- c("#E0F7FA", "#80DEEA", "#26C6DA", "#0097A7", "#006064")
univariado_consumo_det <- ggplot(datos_grafico_cd,
aes(x = consumo_detallado,
y = proporcion,
fill = tipo_medida)) +
geom_col(position = "dodge", width = 0.7) +
scale_fill_manual(values = c(paleta_teal[3], paleta_teal[5])) +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
labs(
title = "Comparación: Muestra vs. Población Estimada",
subtitle = "Distribución de consumo de bebidas azucaradas (detallado)",
x = "Categoría de consumo",
y = "Porcentaje (%)",
fill = "Tipo de Medida",
caption = "Fuente: Elaboración propia"
) +
theme_minimal() +
theme(
plot.title = element_text(face = "bold", size = 14),
legend.position = "bottom",
axis.text = element_text(color = "black", size = 11),
panel.grid = element_blank(),
axis.line = element_line(color = "gray")
) +
geom_text(
aes(label = scales::percent(proporcion, accuracy = 0.1)),
position = position_dodge(width = 0.7),
hjust = -0.1,  # Ajusta la posición horizontal de las etiquetas
size = 3.5
) +
coord_flip()  # Esto voltea el gráfico
print(univariado_consumo_det)
# Guardar gráfico
ggsave("Graficos-tablas/univariado_consumo_detallado.png",
univariado_consumo_det,
width = 8,
height = 6)
# Estadísticos No Ponderados
stats_no_pond <- df_analisis %>%
summarise(
N_obs = n(),
Media = mean(edad, na.rm = TRUE),
DS = sd(edad, na.rm = TRUE),
Q25 = quantile(edad, 0.25, na.rm = TRUE),
Mediana = quantile(edad, 0.50, na.rm = TRUE),
Q75 = quantile(edad, 0.75, na.rm = TRUE),
RIQ = Q75 - Q25,
Min = min(edad, na.rm = TRUE),
Max = max(edad, na.rm = TRUE)
) %>%
mutate(Tipo = "No ponderado")
# Estadísticos Ponderados
stats_pond <- df_analisis %>%
summarise(
N_obs = sum(fex, na.rm = TRUE),
Media = weighted.mean(edad, w = fex, na.rm = TRUE),
DS = sqrt(sum(fex * (edad - weighted.mean(edad, w = fex, na.rm = TRUE))^2, na.rm = TRUE) / sum(fex, na.rm = TRUE)),
Q25 = wtd.quantile(edad, weights = fex, probs = 0.25, na.rm = TRUE),
Mediana = wtd.quantile(edad, weights = fex, probs = 0.5, na.rm = TRUE),
Q75 = wtd.quantile(edad, weights = fex, probs = 0.75, na.rm = TRUE),
RIQ = Q75 - Q25,
Min = min(edad, na.rm = TRUE),
Max = max(edad, na.rm = TRUE)
) %>%
mutate(Tipo = "Ponderado")
# Combinar tablas
tabla_final_edad <- bind_rows(stats_no_pond, stats_pond) %>%
select(Tipo, N_obs, Media, DS, Mediana, RIQ, Min, Max) %>%
mutate(across(c(Media, DS, Mediana, RIQ, Min, Max), ~round(., 2)))
print(tabla_final_edad)
# Gráfico de densidad comparativo
paleta_teal <- c("#0097A7", "#26C6DA")
grafico_densidad_edad <- ggplot() +
geom_density(data = df_analisis,
aes(x = edad, color = "No ponderado", fill = "No ponderado"),
alpha = 0.5, linewidth = 1) +
geom_density(data = df_analisis,
aes(x = edad, weight = fex, color = "Ponderado", fill = "Ponderado"),
alpha = 0.5, linewidth = 1) +
scale_fill_manual(values = c("No ponderado" = paleta_teal[2], "Ponderado" = paleta_teal[1])) +
scale_color_manual(values = c("No ponderado" = paleta_teal[1], "Ponderado" = paleta_teal[1])) +
labs(
title = "Distribución de la Edad: No Ponderada vs Ponderada",
x = "Edad",
y = "Densidad",
fill = "Tipo de Medida",
color = "Tipo de Medida",
caption = "Fuente: Elaboración propia. Los pesos (fex) se aplican al cálculo de la densidad ponderada."
) +
theme_minimal(base_size = 14) +
theme(
plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
legend.position = "bottom",
axis.text = element_text(color = "black")
)
print(grafico_densidad_edad)
# Guardar gráfico
ggsave("Graficos-tablas/univariado_edad.png",
grafico_densidad_edad,
width = 8,
height = 6)
# Estadísticos No Ponderados
stats_no_pond <- df_analisis %>%
summarise(
N_obs = n(),
Media = mean(edad, na.rm = TRUE),
DS = sd(edad, na.rm = TRUE),
Q25 = quantile(edad, 0.25, na.rm = TRUE),
Mediana = quantile(edad, 0.50, na.rm = TRUE),
Q75 = quantile(edad, 0.75, na.rm = TRUE),
RIQ = Q75 - Q25,
Min = min(edad, na.rm = TRUE),
Max = max(edad, na.rm = TRUE)
) %>%
mutate(Tipo = "No ponderado")
# Estadísticos Ponderados
stats_pond <- df_analisis %>%
summarise(
N_obs = sum(fex, na.rm = TRUE),
Media = weighted.mean(edad, w = fex, na.rm = TRUE),
DS = sqrt(sum(fex * (edad - weighted.mean(edad, w = fex, na.rm = TRUE))^2, na.rm = TRUE) / sum(fex, na.rm = TRUE)),
Q25 = wtd.quantile(edad, weights = fex, probs = 0.25, na.rm = TRUE),
Mediana = wtd.quantile(edad, weights = fex, probs = 0.5, na.rm = TRUE),
Q75 = wtd.quantile(edad, weights = fex, probs = 0.75, na.rm = TRUE),
RIQ = Q75 - Q25,
Min = min(edad, na.rm = TRUE),
Max = max(edad, na.rm = TRUE)
) %>%
mutate(Tipo = "Ponderado")
# Combinar tablas
tabla_final_edad <- bind_rows(stats_no_pond, stats_pond) %>%
select(Tipo, N_obs, Media, DS, Mediana, RIQ, Min, Max) %>%
mutate(across(c(Media, DS, Mediana, RIQ, Min, Max), ~round(., 2)))
print(tabla_final_edad)
# Gráfico de densidad comparativo
paleta_teal <- c("#0097A7", "#26C6DA")
grafico_densidad_edad <- ggplot() +
geom_density(data = df_analisis,
aes(x = edad, color = "No ponderado", fill = "No ponderado"),
alpha = 0.5, linewidth = 1) +
geom_density(data = df_analisis,
aes(x = edad, weight = fex, color = "Ponderado", fill = "Ponderado"),
alpha = 0.5, linewidth = 1) +
scale_fill_manual(values = c("No ponderado" = paleta_teal[2], "Ponderado" = paleta_teal[1])) +
scale_color_manual(values = c("No ponderado" = paleta_teal[1], "Ponderado" = paleta_teal[1])) +
labs(
title = "Distribución de la Edad: No Ponderada vs Ponderada",
x = "Edad",
y = "Densidad",
fill = "Tipo de Medida",
color = "Tipo de Medida",
caption = "Fuente: Elaboración propia"
) +
theme_minimal(base_size = 14) +
theme(
plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
legend.position = "bottom",
axis.text = element_text(color = "black")
)
print(grafico_densidad_edad)
# Guardar gráfico
ggsave("Graficos-tablas/univariado_edad.png",
grafico_densidad_edad,
width = 8,
height = 6)
