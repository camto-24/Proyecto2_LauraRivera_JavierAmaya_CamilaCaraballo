cod_mpio_full = str_pad(as.character(cod_mpio_full), 5, pad = "0"),
cod_mpio = str_sub(cod_mpio_full, 3, 5)  # últimos 3 dígitos
) %>%
select(cod_depto, cod_mpio, nombre_depto, nombre_mpio)
# ============================================================================
# 2. PREPARAR TABLA BASE NORMALIZADA
# ============================================================================
df_modelo <- df_bivariado %>%
mutate(
cod_depto = str_pad(as.character(cod_depto), 2, pad = "0"),
cod_mpio  = str_pad(as.character(cod_mpio), 3, pad = "0"),
# IDs correctos (sin guiones)
id_hogar   = paste0(directorio, secuencia_p),
id_persona = paste0(directorio, secuencia_p, orden),
# ID geográfico DANE estándar
id_geografia = paste0(cod_depto, cod_mpio),
# pasar a char para evitar problema en Power BI
directorio_char  = as.character(directorio),
secuencia_p_char = as.character(secuencia_p),
orden_char       = as.character(orden)
)
# ============================================================================
# 3. DIM GEOGRAFÍA
# ============================================================================
dim_geografia <- df_modelo %>%
select(id_geografia, cod_depto, cod_mpio) %>%
distinct() %>%
left_join(dane_mpios, by = c("cod_depto", "cod_mpio")) %>%
select(
id_geografia,
cod_depto, nombre_depto,
cod_mpio,  nombre_mpio
)
# ============================================================================
# 4. DIMENSIONES (solo lo que debe ser dimensión)
# ============================================================================
dim_sexo        <- df_modelo %>% select(sexo) %>% distinct() %>% mutate(id_sexo = row_number())
dim_etario      <- df_modelo %>% select(grupo_edad) %>% distinct() %>% mutate(id_etario = row_number())
dim_parentesco  <- df_modelo %>% select(parentesco) %>% distinct() %>% mutate(id_parentesco = row_number())
dim_educacion   <- df_modelo %>% select(nivel_educativo) %>% distinct() %>% mutate(id_educacion = row_number())
dim_estado_salud<- df_modelo %>% select(estado_salud) %>% distinct() %>% mutate(id_estado_salud = row_number())
dim_cronica     <- df_modelo %>% select(cronica_12m) %>% distinct() %>% mutate(id_cronica = row_number())
dim_paquetes    <- df_modelo %>% select(frecuencia_paquetes) %>% distinct() %>% mutate(id_paquetes = row_number())
dim_consumo <- df_modelo %>%
select(
consume_azucar, frecuencia_azucar, freq_num,
consumo_agrupado, consumo_agrupado_txt, consumo_detallado
) %>%
distinct() %>%
mutate(id_consumo = row_number())
# ============================================================================
# 5. FACT TABLE (ÚNICA TABLA DE HECHOS)
# ============================================================================
fact_personas <- df_modelo %>%
left_join(dim_sexo, "sexo") %>%
left_join(dim_etario, "grupo_edad") %>%
left_join(dim_parentesco, "parentesco") %>%
left_join(dim_educacion, "nivel_educativo") %>%
left_join(dim_estado_salud, "estado_salud") %>%
left_join(dim_cronica, "cronica_12m") %>%
left_join(dim_paquetes, "frecuencia_paquetes") %>%
left_join(dim_consumo,
by = c("consume_azucar","frecuencia_azucar","freq_num",
"consumo_agrupado","consumo_agrupado_txt","consumo_detallado")) %>%
select(
id_persona,
id_hogar,
id_geografia,
id_sexo, id_etario, id_parentesco, id_educacion,
id_estado_salud, id_cronica, id_paquetes, id_consumo,
edad, fex,
cronica_num, freq_num
)
# ============================================================================
# 6. EXPORTAR
# ============================================================================
lista_tablas_final <- list(
"Hechos_Personas"  = fact_personas,
"Dim_Geografia"    = dim_geografia,
"Dim_Sexo"         = dim_sexo,
"Dim_Etario"       = dim_etario,
"Dim_Parentesco"   = dim_parentesco,
"Dim_Educacion"    = dim_educacion,
"Dim_Estado_Salud" = dim_estado_salud,
"Dim_Cond_Cronica" = dim_cronica,
"Dim_Paquetes"     = dim_paquetes,
"Dim_Consumo"      = dim_consumo
)
write_xlsx(lista_tablas_final, "data/Modelo_Datos_Normalizado.xlsx")
library(dplyr)
library(readxl)
library(stringr)
library(writexl)
# ============================================================================
# 1. CARGAR LISTADO DANE Y NORMALIZAR CÓDIGOS
# ============================================================================
dane_mpios <- read_excel("data/Listado_Departamentos.xlsx") %>%
rename(
cod_depto = `Código Departamento`,
cod_mpio_full = `Código Municipio`,
nombre_depto = `Nombre Departamento`,
nombre_mpio  = `Nombre Municipio`
) %>%
mutate(
cod_depto = str_pad(as.character(cod_depto), 2, pad = "0"),
cod_mpio_full = str_pad(as.character(cod_mpio_full), 5, pad = "0"),
cod_mpio = str_sub(cod_mpio_full, 3, 5)
) %>%
select(cod_depto, cod_mpio, nombre_depto, nombre_mpio)
# ============================================================================
# 2. PREPARAR DATAFRAME BASE PARA EL MODELO
# ============================================================================
df_modelo <- df_bivariado %>%
mutate(
directorio_char  = as.character(directorio),
secuencia_p_char = as.character(secuencia_p),
orden_char       = as.character(orden),
cod_depto = str_pad(as.character(cod_depto), 2, pad = "0"),
cod_mpio  = str_pad(as.character(cod_mpio),  3, pad = "0"),
id_hogar   = paste0(directorio, "-", secuencia_p),
id_persona = paste0(directorio, "-", secuencia_p, "-", orden),
id_geografia = paste0(cod_depto, cod_mpio)
)
# ============================================================================
# 3. DIMENSIÓN GEOGRAFÍA
# ============================================================================
dim_geografia <- df_modelo %>%
select(id_geografia, cod_depto, cod_mpio) %>%
distinct() %>%
left_join(dane_mpios, by = c("cod_depto", "cod_mpio")) %>%
select(id_geografia, cod_depto, nombre_depto, cod_mpio, nombre_mpio)
# ============================================================================
# 4. DIMENSIONES DEMOGRÁFICAS Y DE ATRIBUTOS
# ============================================================================
dim_sexo <- df_modelo %>%
select(sexo) %>% distinct() %>% mutate(id_sexo = row_number())
dim_etario <- df_modelo %>%
select(grupo_edad) %>% distinct() %>% mutate(id_etario = row_number())
dim_parentesco <- df_modelo %>%
select(parentesco) %>% distinct() %>% mutate(id_parentesco = row_number())
dim_educacion <- df_modelo %>%
select(nivel_educativo) %>% distinct() %>% mutate(id_educacion = row_number())
dim_estado_salud <- df_modelo %>%
select(estado_salud) %>% distinct() %>% mutate(id_estado_salud = row_number())
dim_cronica <- df_modelo %>%
select(cronica_12m) %>% distinct() %>% mutate(id_cronica = row_number())
dim_paquetes <- df_modelo %>%
select(frecuencia_paquetes) %>% distinct() %>% mutate(id_paquetes = row_number())
dim_consumo <- df_modelo %>%
select(
consume_azucar, frecuencia_azucar, freq_num,
consumo_agrupado, consumo_agrupado_txt, consumo_detallado
) %>%
distinct() %>%
mutate(id_consumo = row_number())
# ============================================================================
# 5. TABLA DE HECHO HOGAR (como en el modelo estrella del ejemplo)
# ============================================================================
fact_hogar <- df_modelo %>%
select(
id_hogar,
id_geografia,
directorio = directorio_char,
secuencia_p = secuencia_p_char,
ingreso_pc,
fex_hogar = fex_hog,       # si tu variable se llama diferente, cámbiala
clase,
tipo_vivienda,
estrato
) %>%
distinct()
library(dplyr)
library(readxl)
library(stringr)
library(writexl)
# ============================================================================
# 1. CARGAR LISTADO DANE Y NORMALIZAR CÓDIGOS
# ============================================================================
dane_mpios <- read_excel("data/Listado_Departamentos.xlsx") %>%
rename(
cod_depto = `Código Departamento`,
cod_mpio_full = `Código Municipio`,
nombre_depto = `Nombre Departamento`,
nombre_mpio  = `Nombre Municipio`
) %>%
mutate(
cod_depto = str_pad(as.character(cod_depto), 2, pad = "0"),
cod_mpio_full = str_pad(as.character(cod_mpio_full), 5, pad = "0"),
cod_mpio = str_sub(cod_mpio_full, 3, 5)
) %>%
select(cod_depto, cod_mpio, nombre_depto, nombre_mpio)
# ============================================================================
# 2. PREPARAR DATAFRAME BASE PARA EL MODELO
# ============================================================================
df_modelo <- df_bivariado %>%
mutate(
directorio_char  = as.character(directorio),
secuencia_p_char = as.character(secuencia_p),
orden_char       = as.character(orden),
cod_depto = str_pad(as.character(cod_depto), 2, pad = "0"),
cod_mpio  = str_pad(as.character(cod_mpio),  3, pad = "0"),
id_hogar   = paste0(directorio, "-", secuencia_p),
id_persona = paste0(directorio, "-", secuencia_p, "-", orden),
id_geografia = paste0(cod_depto, cod_mpio)
)
# ============================================================================
# 3. DIMENSIÓN GEOGRAFÍA
# ============================================================================
dim_geografia <- df_modelo %>%
select(id_geografia, cod_depto, cod_mpio) %>%
distinct() %>%
left_join(dane_mpios, by = c("cod_depto", "cod_mpio")) %>%
select(id_geografia, cod_depto, nombre_depto, cod_mpio, nombre_mpio)
# ============================================================================
# 4. DIMENSIONES DEMOGRÁFICAS Y DE ATRIBUTOS
# ============================================================================
dim_sexo <- df_modelo %>%
select(sexo) %>% distinct() %>% mutate(id_sexo = row_number())
dim_etario <- df_modelo %>%
select(grupo_edad) %>% distinct() %>% mutate(id_etario = row_number())
dim_parentesco <- df_modelo %>%
select(parentesco) %>% distinct() %>% mutate(id_parentesco = row_number())
dim_educacion <- df_modelo %>%
select(nivel_educativo) %>% distinct() %>% mutate(id_educacion = row_number())
dim_estado_salud <- df_modelo %>%
select(estado_salud) %>% distinct() %>% mutate(id_estado_salud = row_number())
dim_cronica <- df_modelo %>%
select(cronica_12m) %>% distinct() %>% mutate(id_cronica = row_number())
dim_paquetes <- df_modelo %>%
select(frecuencia_paquetes) %>% distinct() %>% mutate(id_paquetes = row_number())
dim_consumo <- df_modelo %>%
select(
consume_azucar, frecuencia_azucar, freq_num,
consumo_agrupado, consumo_agrupado_txt, consumo_detallado
) %>%
distinct() %>%
mutate(id_consumo = row_number())
# ============================================================================
# 5. TABLA DE HECHO HOGAR (como en el modelo estrella del ejemplo)
# ============================================================================
fact_hogar <- df_modelo %>%
select(
id_hogar,
id_geografia,
directorio = directorio_char,
secuencia_p = secuencia_p_char,
ingreso_pc,
fex_hogar = fex,       # si tu variable se llama diferente, cámbiala
clase,
tipo_vivienda,
estrato
) %>%
distinct()
library(dplyr)
library(readxl)
library(stringr)
library(writexl)
# ============================================================================
# 1. CARGAR LISTADO DANE Y NORMALIZAR CÓDIGOS
# ============================================================================
dane_mpios <- read_excel("data/Listado_Departamentos.xlsx") %>%
rename(
cod_depto = `Código Departamento`,
cod_mpio_full = `Código Municipio`,
nombre_depto = `Nombre Departamento`,
nombre_mpio  = `Nombre Municipio`
) %>%
mutate(
cod_depto = str_pad(as.character(cod_depto), 2, pad = "0"),
cod_mpio_full = str_pad(as.character(cod_mpio_full), 5, pad = "0"),
cod_mpio = str_sub(cod_mpio_full, 3, 5)
) %>%
select(cod_depto, cod_mpio, nombre_depto, nombre_mpio)
# ============================================================================
# 2. PREPARAR DATAFRAME BASE PARA EL MODELO
# ============================================================================
df_modelo <- df_bivariado %>%
mutate(
directorio_char  = as.character(directorio),
secuencia_p_char = as.character(secuencia_p),
orden_char       = as.character(orden),
cod_depto = str_pad(as.character(cod_depto), 2, pad = "0"),
cod_mpio  = str_pad(as.character(cod_mpio),  3, pad = "0"),
id_hogar   = paste0(directorio, "-", secuencia_p),
id_persona = paste0(directorio, "-", secuencia_p, "-", orden),
id_geografia = paste0(cod_depto, cod_mpio)
)
# ============================================================================
# 3. DIMENSIÓN GEOGRAFÍA
# ============================================================================
dim_geografia <- df_modelo %>%
select(id_geografia, cod_depto, cod_mpio) %>%
distinct() %>%
left_join(dane_mpios, by = c("cod_depto", "cod_mpio")) %>%
select(id_geografia, cod_depto, nombre_depto, cod_mpio, nombre_mpio)
# ============================================================================
# 4. DIMENSIONES DEMOGRÁFICAS Y DE ATRIBUTOS
# ============================================================================
dim_sexo <- df_modelo %>%
select(sexo) %>% distinct() %>% mutate(id_sexo = row_number())
dim_etario <- df_modelo %>%
select(grupo_edad) %>% distinct() %>% mutate(id_etario = row_number())
dim_parentesco <- df_modelo %>%
select(parentesco) %>% distinct() %>% mutate(id_parentesco = row_number())
dim_educacion <- df_modelo %>%
select(nivel_educativo) %>% distinct() %>% mutate(id_educacion = row_number())
dim_estado_salud <- df_modelo %>%
select(estado_salud) %>% distinct() %>% mutate(id_estado_salud = row_number())
dim_cronica <- df_modelo %>%
select(cronica_12m) %>% distinct() %>% mutate(id_cronica = row_number())
dim_paquetes <- df_modelo %>%
select(frecuencia_paquetes) %>% distinct() %>% mutate(id_paquetes = row_number())
dim_consumo <- df_modelo %>%
select(
consume_azucar, frecuencia_azucar, freq_num,
consumo_agrupado, consumo_agrupado_txt, consumo_detallado
) %>%
distinct() %>%
mutate(id_consumo = row_number())
# ============================================================================
# 5. TABLA DE HECHO HOGAR (como en el modelo estrella del ejemplo)
# ============================================================================
fact_hogar <- df_modelo %>%
select(
id_hogar,
id_geografia,
directorio = directorio_char,
secuencia_p = secuencia_p_char,
ingreso_pc,
fex_hogar = fex,       # si tu variable se llama diferente, cámbiala
) %>%
distinct()
# ============================================================================
# 6. TABLA DE HECHO PERSONAS
# ============================================================================
fact_personas <- df_modelo %>%
left_join(dim_sexo, "sexo") %>%
left_join(dim_etario, "grupo_edad") %>%
left_join(dim_parentesco, "parentesco") %>%
left_join(dim_educacion, "nivel_educativo") %>%
left_join(dim_estado_salud, "estado_salud") %>%
left_join(dim_cronica, "cronica_12m") %>%
left_join(dim_paquetes, "frecuencia_paquetes") %>%
left_join(
dim_consumo,
by = c("consume_azucar","frecuencia_azucar","freq_num",
"consumo_agrupado","consumo_agrupado_txt","consumo_detallado")
) %>%
select(
id_persona,
id_hogar,
id_geografia,
id_sexo,
id_etario,
id_parentesco,
id_educacion,
id_estado_salud,
id_cronica,
id_paquetes,
id_consumo,
edad,
fex_persona = fex,
cronica_num,
freq_num
)
# ============================================================================
# 7. EXPORTAR TODO EL MODELO NORMALIZADO
# ============================================================================
lista_tablas_final <- list(
"Hechos_Hogar"      = fact_hogar,
"Hechos_Personas"   = fact_personas,
"Dim_Geografia"     = dim_geografia,
"Dim_Sexo"          = dim_sexo,
"Dim_Etario"        = dim_etario,
"Dim_Parentesco"    = dim_parentesco,
"Dim_Educacion"     = dim_educacion,
"Dim_Estado_Salud"  = dim_estado_salud,
"Dim_Cond_Cronica"  = dim_cronica,
"Dim_Paquetes"      = dim_paquetes,
"Dim_Consumo"       = dim_consumo
)
write_xlsx(lista_tablas_final, "data/Modelo_Datos_Normalizado.xlsx")
library(dplyr)
library(readxl)
library(stringr)
library(writexl)
# ============================================================================
# 1. CARGAR LISTADO DANE Y NORMALIZAR CÓDIGOS
# ============================================================================
dane_mpios <- read_excel("data/Listado_Departamentos.xlsx") %>%
rename(
cod_depto = `Código Departamento`,
cod_mpio_full = `Código Municipio`,
nombre_depto = `Nombre Departamento`,
nombre_mpio  = `Nombre Municipio`
) %>%
mutate(
cod_depto = str_pad(as.character(cod_depto), 2, pad = "0"),
cod_mpio_full = str_pad(as.character(cod_mpio_full), 5, pad = "0"),
cod_mpio = str_sub(cod_mpio_full, 3, 5)
) %>%
select(cod_depto, cod_mpio, nombre_depto, nombre_mpio) %>%
distinct()
# ============================================================================
# 2. PREPARAR DATAFRAME BASE PARA EL MODELO
# ============================================================================
df_modelo <- df_bivariado %>%
mutate(
directorio_char  = as.character(directorio),
secuencia_p_char = as.character(secuencia_p),
orden_char       = as.character(orden),
cod_depto = str_pad(as.character(cod_depto), 2, pad = "0"),
cod_mpio  = str_pad(as.character(cod_mpio),  3, pad = "0"),
id_hogar   = paste0(directorio, "-", secuencia_p),
id_persona = paste0(directorio, "-", secuencia_p, "-", orden),
id_geografia = paste0(cod_depto, cod_mpio)
)
# ============================================================================
# 3. DIMENSIÓN GEOGRAFÍA
# ============================================================================
dim_geografia <- df_modelo %>%
select(id_geografia, cod_depto, cod_mpio) %>%
distinct() %>%
left_join(dane_mpios, by = c("cod_depto", "cod_mpio")) %>%
select(id_geografia, cod_depto, nombre_depto, cod_mpio, nombre_mpio)
# ============================================================================
# 4. DIMENSIONES DEMOGRÁFICAS Y DE ATRIBUTOS
# ============================================================================
dim_sexo <- df_modelo %>%
select(sexo) %>% distinct() %>% mutate(id_sexo = row_number())
dim_etario <- df_modelo %>%
select(grupo_edad) %>% distinct() %>% mutate(id_etario = row_number())
dim_parentesco <- df_modelo %>%
select(parentesco) %>% distinct() %>% mutate(id_parentesco = row_number())
dim_educacion <- df_modelo %>%
select(nivel_educativo) %>% distinct() %>% mutate(id_educacion = row_number())
dim_estado_salud <- df_modelo %>%
select(estado_salud) %>% distinct() %>% mutate(id_estado_salud = row_number())
dim_cronica <- df_modelo %>%
select(cronica_12m) %>% distinct() %>% mutate(id_cronica = row_number())
dim_paquetes <- df_modelo %>%
select(frecuencia_paquetes) %>% distinct() %>% mutate(id_paquetes = row_number())
dim_consumo <- df_modelo %>%
select(
consume_azucar, frecuencia_azucar, freq_num,
consumo_agrupado, consumo_agrupado_txt, consumo_detallado
) %>%
distinct() %>%
mutate(id_consumo = row_number())
# ============================================================================
# 5. TABLA DE HECHO HOGAR (como en el modelo estrella del ejemplo)
# ============================================================================
fact_hogar <- df_modelo %>%
select(
id_hogar,
id_geografia,
directorio = directorio_char,
secuencia_p = secuencia_p_char,
ingreso_pc,
fex_hogar = fex,       # si tu variable se llama diferente, cámbiala
) %>%
distinct()
# ============================================================================
# 6. TABLA DE HECHO PERSONAS
# ============================================================================
fact_personas <- df_modelo %>%
left_join(dim_sexo, "sexo") %>%
left_join(dim_etario, "grupo_edad") %>%
left_join(dim_parentesco, "parentesco") %>%
left_join(dim_educacion, "nivel_educativo") %>%
left_join(dim_estado_salud, "estado_salud") %>%
left_join(dim_cronica, "cronica_12m") %>%
left_join(dim_paquetes, "frecuencia_paquetes") %>%
left_join(
dim_consumo,
by = c("consume_azucar","frecuencia_azucar","freq_num",
"consumo_agrupado","consumo_agrupado_txt","consumo_detallado")
) %>%
select(
id_persona,
id_hogar,
id_geografia,
id_sexo,
id_etario,
id_parentesco,
id_educacion,
id_estado_salud,
id_cronica,
id_paquetes,
id_consumo,
edad,
fex_persona = fex,
cronica_num,
freq_num
)
# ============================================================================
# 7. EXPORTAR TODO EL MODELO NORMALIZADO
# ============================================================================
lista_tablas_final <- list(
"Hechos_Hogar"      = fact_hogar,
"Hechos_Personas"   = fact_personas,
"Dim_Geografia"     = dim_geografia,
"Dim_Sexo"          = dim_sexo,
"Dim_Etario"        = dim_etario,
"Dim_Parentesco"    = dim_parentesco,
"Dim_Educacion"     = dim_educacion,
"Dim_Estado_Salud"  = dim_estado_salud,
"Dim_Cond_Cronica"  = dim_cronica,
"Dim_Paquetes"      = dim_paquetes,
"Dim_Consumo"       = dim_consumo
)
write_xlsx(lista_tablas_final, "data/Modelo_Datos_Normalizado.xlsx")
