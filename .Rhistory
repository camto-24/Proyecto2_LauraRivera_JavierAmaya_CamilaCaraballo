geom_text(aes(label = paste0(round(preva_100, 1), "%")),
color = ifelse(df_heatmap_sexo$preva_100 > 25, "white", "#2c3e50"),
size = 3, fontface = "bold") +
scale_fill_gradientn(colors = paleta_teal, labels = percent_format()) +
labs(
title = "Mapa de Calor: Riesgo de enfermedad crónica por Sexo",
subtitle = "Comparación de perfiles epidemiológicos y sesgo de supervivencia",
x = NULL, y = NULL, fill = "Prevalencia"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1, size = 9),
axis.text.y = element_text(size = 10, face = "bold"),
strip.text = element_text(size = 12, face = "bold", color = "#006064"),
panel.grid = element_blank()
)
# Guardar Gráficos
ggsave("Graficos-tablas/bivariado_graph_global.png", p_global, width = 8, height = 6)
ggsave("Graficos-tablas/bivariado_graph_edad.png", p_estratificado, width = 10, height = 6)
ggsave("Graficos-tablas/heatmap_graph_edad_sexo.png", p_heatmap_sexo, width = 12, height = 7)
# Mostrar en RMarkdown
print(p_global)
print(p_estratificado)
print(p_heatmap_sexo)
# 2. VISUALIZACIÓN (Ajustada a tus nuevas variables)
# -------------------------------------------------------------------------
# A) GRÁFICO GLOBAL
p_global <- ggplot(df_grafico_global, aes(x = consumo_agrupado, y = prevalencia)) +
geom_line(group = 1, linetype = "dashed", color = "grey50") +
geom_point(size = 5, color = "#4E79A7") +
# AQUI USAMOS TU VARIABLE 'preva_100' PARA LA ETIQUETA
geom_text(aes(label = paste0(round(preva_100, 1), "%")),
vjust = -1.5, size = 4, fontface = "bold", color = "#2c3e50") +
# El eje Y sigue usando 'prevalencia' (decimal) para formatearse correctamente
scale_y_continuous(labels = percent_format(),
limits = c(0, 0.30)) +
labs(
title = "Prevalencia de enf. crónica según intensidad de consumo",
subtitle = "Análisis global = paradoja de causalidad reversa",
x = NULL,
y = "Prevalencia (%)",
caption = "Fuente: ECV 2023. Población expandida (fex)."
) +
theme_few() +
theme(axis.text.x = element_text(angle = 15, hjust = 1))
# B) GRÁFICO ESTRATIFICADO
p_estratificado <- ggplot(df_grafico_estratificado,
aes(x = consumo_agrupado, y = prevalencia, color = grupo_edad)) +
geom_line(aes(group = grupo_edad), size = 1, alpha = 0.8) +
geom_point(size = 3) +
facet_wrap(~grupo_edad, scales = "free_y") +
scale_y_continuous(labels = percent_format(accuracy = 0.1)) +
scale_color_paletteer_d("ggthemes::Tableau_10") +
labs(
title = "Prevalencia de enf. crónica según intensidad de consumo por grupo etario",
x = "Frecuencia de consumo",
y = "Prevalencia (%)",
color = "Grupo de edad"
) +
theme_few() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "none",
strip.text = element_text(face = "bold")
)
# Imprimir y Guardar
print(p_global)
print(p_estratificado)
ggsave("Graficos-tablas/bivariado_global.png", p_global, width = 8, height = 6)
ggsave("Graficos-tablas/bivariado_estratificado_edad.png", p_estratificado, width = 10, height = 6)
p_lineas_sexo <- ggplot(df_grafico_sexo,
aes(x = consumo_agrupado, y = prevalencia, color = sexo, group = sexo)) +
geom_line(size = 1.2) +
geom_point(size = 2.5) +
# Paneles por edad (volvemos al orden original para líneas)
facet_wrap(~ fct_rev(grupo_edad), nrow = 1) +
scale_y_continuous(labels = percent_format(accuracy = 1)) +
# Colores manuales dentro de tu gama:
# Hombre = Azul Petróleo Oscuro, Mujer = Turquesa Vibrante
scale_color_manual(values = c("Hombre" = "#2c3e50", "Mujer" = "#26C6DA")) +
labs(
title = "Tendencias por Sexo a través del Ciclo Vital",
subtitle = "¿Afecta el consumo de igual manera a hombres y mujeres?",
x = NULL,
y = "Prevalencia (%)"
) +
theme_few() +
theme(
axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
legend.position = "bottom"
)
print(p_lineas_sexo)
# ==============================================================================
# Visualización bivariada
library(ggplot2)
library(ggthemes)
library(scales)
library(paletteer)
# Definiendo la paleta
paleta_teal <- c("#E0F7FA", "#80DEEA", "#26C6DA", "#0097A7", "#006064")
# --- GRÁFICO 1: GLOBAL (PARADOJA) ---
p_global <- ggplot(df_grafico_global, aes(x = consumo_agrupado, y = prevalencia)) +
geom_line(group = 1, linetype = "dashed", color = "grey50") +
geom_point(size = 5, color = "#4E79A7") +
geom_text(aes(label = paste0(round(preva_100, 1), "%")),
vjust = -1.5, size = 4, fontface = "bold", color = "#2c3e50") +
scale_y_continuous(labels = percent_format(), limits = c(0, 0.30)) +
labs(
title = "Prevalencia de enf. crónica según intensidad de consumo",
subtitle = "Análisis global: paradoja de causalidad reversa",
x = NULL, y = "Prevalencia (%)",
caption = "Fuente: ECV 2023. Población expandida."
) +
theme_few() +
theme(axis.text.x = element_text(angle = 15, hjust = 1))
# --- GRÁFICO 2: ESTRATIFICADO POR EDAD (CURVA J) ---
p_estratificado <- ggplot(df_grafico_estratificado,
aes(x = consumo_agrupado, y = prevalencia, color = grupo_edad)) +
geom_line(aes(group = grupo_edad), size = 1, alpha = 0.8) +
geom_point(size = 3) +
facet_wrap(~grupo_edad, scales = "free_y") +
scale_y_continuous(labels = percent_format(accuracy = 0.1)) +
scale_color_paletteer_d("ggthemes::Tableau_10") +
labs(
title = "Prevalencia según intensidad de consumo por grupo etario",
subtitle = "Controlando por edad aparecen patrones de riesgo (Curva J)",
x = "Frecuencia de consumo", y = "Prevalencia (%)", color = "Grupo de edad"
) +
theme_few() +
theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
strip.text = element_text(face = "bold"))
# --- GRÁFICO 3: MAPA DE CALOR SEXO ---
df_heatmap_sexo <- df_grafico_sexo %>% mutate(grupo_edad = fct_rev(grupo_edad))
p_heatmap_sexo <- ggplot(df_heatmap_sexo, aes(x = consumo_agrupado, y = grupo_edad, fill = prevalencia)) +
geom_tile(color = "white", linewidth = 0.5) +
facet_wrap(~sexo) +
geom_text(aes(label = paste0(round(preva_100, 1), "%")),
color = ifelse(df_heatmap_sexo$preva_100 > 25, "white", "#2c3e50"),
size = 3, fontface = "bold") +
scale_fill_gradientn(colors = paleta_teal, labels = percent_format()) +
labs(
title = "Mapa de calor: riesgo de enfermedad crónica por Sexo",
subtitle = "Efecto del sesgo de supervivencia",
x = NULL, y = NULL, fill = "Prevalencia"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1, size = 9),
axis.text.y = element_text(size = 10, face = "bold"),
strip.text = element_text(size = 12, face = "bold", color = "#006064"),
panel.grid = element_blank()
)
# Guardar Gráficos
ggsave("Graficos-tablas/bivariado_graph_global.png", p_global, width = 8, height = 6)
ggsave("Graficos-tablas/bivariado_graph_edad.png", p_estratificado, width = 10, height = 6)
ggsave("Graficos-tablas/bivariado_heatmap_graph_edad_sexo.png", p_heatmap_sexo, width = 12, height = 7)
# Mostrar en RMarkdown
print(p_global)
print(p_estratificado)
print(p_heatmap_sexo)
# ==============================================================================
# Visualización bivariada
library(ggplot2)
library(ggthemes)
library(scales)
library(paletteer)
# Definiendo la paleta
paleta_teal <- c("#E0F7FA", "#80DEEA", "#26C6DA", "#0097A7", "#006064")
# --- GRÁFICO 1: GLOBAL (PARADOJA) ---
p_global <- ggplot(df_grafico_global, aes(x = consumo_agrupado, y = prevalencia)) +
geom_line(group = 1, linetype = "dashed", color = "grey50") +
geom_point(size = 5, color = "#4E79A7") +
geom_text(aes(label = paste0(round(preva_100, 1), "%")),
vjust = -1.5, size = 4, fontface = "bold", color = "#2c3e50") +
scale_y_continuous(labels = percent_format(), limits = c(0, 0.30)) +
labs(
title = "Prevalencia de enf. crónica según intensidad de consumo",
subtitle = "Análisis global: paradoja de causalidad reversa",
x = NULL, y = "Prevalencia (%)",
caption = "Fuente: ECV 2023. Población expandida."
) +
theme_few() +
theme(axis.text.x = element_text(angle = 15, hjust = 1))
# --- GRÁFICO 2: ESTRATIFICADO POR EDAD (CURVA J) ---
p_estratificado <- ggplot(df_grafico_estratificado,
aes(x = consumo_agrupado, y = prevalencia, color = grupo_edad)) +
geom_line(aes(group = grupo_edad), size = 1, alpha = 0.8) +
geom_point(size = 3) +
facet_wrap(~grupo_edad, scales = "free_y") +
scale_y_continuous(labels = percent_format(accuracy = 0.1)) +
scale_color_paletteer_d("ggthemes::Tableau_10") +
labs(
title = "Prevalencia según intensidad de consumo por grupo etario",
subtitle = "Controlando por edad aparecen patrones de riesgo (Curva J)",
x = "Frecuencia de consumo", y = "Prevalencia (%)", color = "Grupo de edad"
) +
theme_few() +
theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none",
strip.text = element_text(face = "bold"))
# --- GRÁFICO 3: MAPA DE CALOR SEXO ---
df_heatmap_sexo <- df_grafico_sexo %>% mutate(grupo_edad = fct_rev(grupo_edad))
p_heatmap_sexo <- ggplot(df_heatmap_sexo, aes(x = consumo_agrupado, y = grupo_edad, fill = prevalencia)) +
geom_tile(color = "white", linewidth = 0.5) +
facet_wrap(~sexo) +
geom_text(aes(label = paste0(round(preva_100, 1), "%")),
color = ifelse(df_heatmap_sexo$preva_100 > 25, "white", "#2c3e50"),
size = 3, fontface = "bold") +
scale_fill_gradientn(colors = paleta_teal, labels = percent_format()) +
labs(
title = "Mapa de calor: riesgo de enfermedad crónica por Sexo",
subtitle = "Efecto del sesgo de supervivencia",
x = NULL, y = NULL, fill = "Prevalencia"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1, size = 9),
axis.text.y = element_text(size = 10, face = "bold"),
strip.text = element_text(size = 12, face = "bold", color = "#006064"),
panel.grid = element_blank()
)
# --- GRÁFICO 4: TENDENCIAS POR SEXO ---
p_lineas_sexo <- ggplot(df_grafico_sexo,
aes(x = consumo_agrupado, y = prevalencia, color = sexo, group = sexo)) +
geom_line(size = 1.2, alpha = 0.9) +
geom_point(size = 3) +
# Haciendo el faceting por grupo de edad
facet_wrap(~grupo_edad, nrow = 1) +
scale_y_continuous(labels = percent_format(accuracy = 1)) +
# Paleta seleccionada para el proyecto
scale_color_manual(values = c("Hombre" = "#2c3e50", "Mujer" = "#26C6DA")) +
labs(
title = "Tendencias por sexo y grupo etario",
subtitle = "Comparación de prevalencia entre hombres y mujeres",
x = NULL,
y = "Prevalencia (%)",
color = "Sexo"
) +
theme_few() +
theme(
axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
legend.position = "bottom",
strip.text = element_text(face = "bold")
)
# Guardar Gráficos
ggsave("Graficos-tablas/bivariado_graph_global.png", p_global, width = 8, height = 6)
ggsave("Graficos-tablas/bivariado_graph_edad.png", p_estratificado, width = 10, height = 6)
ggsave("Graficos-tablas/bivariado_heatmap_graph_edad_sexo.png", p_heatmap_sexo, width = 12, height = 7)
ggsave("Graficos-tablas/lineas_sexo.png", p_lineas_sexo, width = 12, height = 6)
# Mostrar en RMarkdown
print(p_global)
print(p_estratificado)
print(p_heatmap_sexo)
print(p_lineas_sexo)
ggsave("Graficos-tablas/bivaariado_lineas_sexo_edad.png", p_lineas_sexo, width = 12, height = 6)
# --- CHUNK 5: Test de Independencia con Diseño Muestral ---
library(survey)
# Definiendo el diseño muestral
diseno_muestral <- svydesign(ids = ~1, weights = ~fex, data = df_bivariado)
# Tabla cruzada ponderada
print("--- Tabla de Contingencia Poblacional (Millones de personas) ---")
svytable(~consumo_agrupado + cronica_binaria, design = diseno_muestral)
# Test de Chi-Cuadrado de Rao-Scott (Corrección para encuestas complejas)
test_survey <- svychisq(~consumo_agrupado + cronica_binaria, design = diseno_muestral)
print("--- Resultado Chi-Cuadrado Ajustado (Rao-Scott) ---")
print(test_survey)
library(survey)
library(broom)
# Configuración de Referencias:
# Referencia: Frecuente (Control) | Jóvenes | Hombres
df_model <- df_bivariado %>%
mutate(
consumo_agrupado = relevel(consumo_agrupado, ref = "Frecuente (2-6/sem)"),
grupo_edad = relevel(grupo_edad, ref = "Jóvenes (18-29)"),
sexo = relevel(sexo, ref = "Hombre")
)
# Diseño Muestral
diseno_muestral <- svydesign(ids = ~1, weights = ~fex, data = df_model)
# Ajuste del Modelo (Interacción Triple)
modelo_interaccion <- svyglm(
cronica_num ~ consumo_agrupado * grupo_edad * sexo,
design = diseno_muestral,
family = quasibinomial()
)
# Tabla de Resultados Tidy
tabla_resultados <- tidy(modelo_interaccion, exponentiate = TRUE, conf.int = TRUE) %>%
select(term, estimate, conf.low, conf.high, p.value) %>%
mutate(
across(c(estimate, conf.low, conf.high), \(x) round(x, 2)),
p_valor_formato = ifelse(p.value < 0.001, "< 0.001", as.character(round(p.value, 3)))
) %>%
# Limpieza de nombres de variables
mutate(term = gsub("consumo_agrupado", "Consumo: ", term),
term = gsub("grupo_edad", "Edad: ", term),
term = gsub("sexoMujer", "Mujer", term),
term = gsub(":", " x ", term))
# Preparación de datos para el Forest Plot
# Clasificamos los coeficientes según el mecanismo económico/epidemiológico
df_forest_conceptual <- tabla_resultados %>%
filter(term == "Mujer" | grepl("Consumo", term)) %>%
filter(!grepl("Edad", term)) %>% # Filtramos interacciones de edad para limpieza visual
mutate(
Mecanismo = case_when(
grepl("Diario", term) & !grepl("Mujer", term) ~ "1. Efecto Tratamiento (Margen Intensivo)",
(grepl("No consume", term) | grepl("Ocasional", term)) & !grepl("Mujer", term) ~ "2. Sesgo de Endogeneidad (Causalidad Inversa)",
term == "Mujer" ~ "3. Control de Heterogeneidad (Sexo)",
TRUE ~ "Otros"
),
term_clean = case_when(
grepl("Diario", term) ~ "Consumo Diario (Intensificación)",
grepl("Ocasional", term) ~ "Consumo Ocasional (Reducción)",
grepl("No consume", term) ~ "No Consume (Abstinencia)",
term == "Mujer" ~ "Ser Mujer (vs Hombre)",
TRUE ~ term
)
) %>%
filter(Mecanismo != "Otros") %>%
filter(!grepl("Mujer", term) | term == "Mujer")
# B) Generación del Gráfico
p_forest_concept <- ggplot(df_forest_conceptual,
aes(x = estimate, y = reorder(term_clean, estimate), color = Mecanismo)) +
geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.3, size = 0.8) +
geom_point(size = 4) +
geom_text(aes(label = paste0("OR: ", estimate)), vjust = -1.5, size = 3.5, fontface = "bold") +
# Facetas con títulos centrados arriba
facet_wrap(~Mecanismo, ncol = 1, scales = "free_y") +
scale_x_log10() +
scale_color_manual(values = c(
"1. Efecto Tratamiento (Margen Intensivo)" = "#D62728",
"2. Sesgo de Endogeneidad (Causalidad Inversa)" = "#FF7F0E",
"3. Control de Heterogeneidad (Sexo)" = "#1F77B4"
)) +
labs(
title = "Identificación del Efecto del Consumo de Azúcar",
subtitle = "Odds Ratios controlando por Endogeneidad (Ref: Consumo Frecuente)",
x = "Odds Ratio (Escala Log)", y = NULL,
caption = "Nota: Estimación svyglm ponderada. Panel 1 muestra efecto estructural. Panel 2 muestra selección adversa."
) +
theme_bw() +
theme(
axis.text.y = element_text(face = "bold", size = 11),
strip.text = element_text(face = "bold", size = 11, color = "white", hjust = 0.5), # Centrado
strip.background = element_rect(fill = "#2c3e50"),
legend.position = "none",
panel.grid.minor = element_blank(),
panel.spacing = unit(1, "lines")
)
print(p_forest_concept)
ggsave("Graficos-tablas/forest_conceptual.png", p_forest_concept, width = 11, height = 8)
# Preparación de datos para el Forest Plot
# Clasificamos los coeficientes según el mecanismo económico/epidemiológico
df_forest_conceptual <- tabla_resultados %>%
filter(term == "Mujer" | grepl("Consumo", term)) %>%
filter(!grepl("Edad", term)) %>% # Filtramos interacciones de edad para limpieza visual
mutate(
Mecanismo = case_when(
grepl("Diario", term) & !grepl("Mujer", term) ~ "1. Efecto Tratamiento (Margen Intensivo)",
(grepl("No consume", term) | grepl("Ocasional", term)) & !grepl("Mujer", term) ~ "2. Sesgo de Endogeneidad (Causalidad Inversa)",
term == "Mujer" ~ "3. Control de Heterogeneidad (Sexo)",
TRUE ~ "Otros"
),
term_clean = case_when(
grepl("Diario", term) ~ "Consumo Diario (Intensificación)",
grepl("Ocasional", term) ~ "Consumo Ocasional (Reducción)",
grepl("No consume", term) ~ "No Consume (Abstinencia)",
term == "Mujer" ~ "Ser Mujer (vs Hombre)",
TRUE ~ term
)
) %>%
filter(Mecanismo != "Otros") %>%
filter(!grepl("Mujer", term) | term == "Mujer")
# B) Generación del Gráfico
p_forest_concept <- ggplot(df_forest_conceptual,
aes(x = estimate, y = reorder(term_clean, estimate), color = Mecanismo)) +
geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.3, size = 0.8) +
geom_point(size = 4) +
geom_text(aes(label = paste0("OR: ", estimate)), vjust = -1.5, size = 3.5, fontface = "bold") +
# Facetas con títulos centrados arriba
facet_wrap(~Mecanismo, ncol = 1, scales = "free_y") +
scale_x_log10() +
scale_color_manual(values = c(
"1. Efecto tratamiento (margen intensivo)" = "#D62728",
"2. Sesgo de endogeneidad (causalidad reversa)" = "#FF7F0E",
"3. Control de heterogeneidad (sexo)" = "#1F77B4"
)) +
labs(
title = "Identificación del efecto del consumo de azúcar",
subtitle = "Odds Ratios usando como referencia el consumo Frecuente)",
x = "Odds Ratio", y = NULL,
caption = "Nota: Estimación svyglm ponderada. Panel 1 muestra efecto estructural. Panel 2 muestra selección adversa."
) +
theme_bw() +
theme(
axis.text.y = element_text(face = "bold", size = 11),
strip.text = element_text(face = "bold", size = 11, color = "white", hjust = 0.5), # Centrado
strip.background = element_rect(fill = "#2c3e50"),
legend.position = "none",
panel.grid.minor = element_blank(),
panel.spacing = unit(1, "lines")
)
print(p_forest_concept)
ggsave("Graficos-tablas/bivariado_forest_conceptual_multivariado.png", p_forest_concept, width = 11, height = 8)
# Preparación de datos para el Forest Plot
# Clasificamos los coeficientes según el mecanismo económico/epidemiológico
df_forest_conceptual <- tabla_resultados %>%
filter(term == "Mujer" | grepl("Consumo", term)) %>%
filter(!grepl("Edad", term)) %>% # Filtramos interacciones de edad para limpieza visual
mutate(
Mecanismo = case_when(
grepl("Diario", term) & !grepl("Mujer", term) ~ "1. Efecto tratamiento (margen intensivo)",
(grepl("No consume", term) | grepl("Ocasional", term)) & !grepl("Mujer", term) ~ "2. Sesgo de endogeneidad (causalidad reversa)",
term == "Mujer" ~ "3. Control de heterogeneidad (sexo)",
TRUE ~ "Otros"
),
term_clean = case_when(
grepl("Diario", term) ~ "Consumo Diario (Intensificación)",
grepl("Ocasional", term) ~ "Consumo Ocasional (Reducción)",
grepl("No consume", term) ~ "No Consume (Abstinencia)",
term == "Mujer" ~ "Ser Mujer (vs Hombre)",
TRUE ~ term
)
) %>%
filter(Mecanismo != "Otros") %>%
filter(!grepl("Mujer", term) | term == "Mujer")
# B) Generación del Gráfico
p_forest_concept <- ggplot(df_forest_conceptual,
aes(x = estimate, y = reorder(term_clean, estimate), color = Mecanismo)) +
geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.3, size = 0.8) +
geom_point(size = 4) +
geom_text(aes(label = paste0("OR: ", estimate)), vjust = -1.5, size = 3.5, fontface = "bold") +
# Facetas con títulos centrados arriba
facet_wrap(~Mecanismo, ncol = 1, scales = "free_y") +
scale_x_log10() +
scale_color_manual(values = c(
"1. Efecto tratamiento (margen intensivo)" = "#D62728",
"2. Sesgo de endogeneidad (causalidad reversa)" = "#FF7F0E",
"3. Control de heterogeneidad (sexo)" = "#1F77B4"
)) +
labs(
title = "Identificación del efecto del consumo de azúcar",
subtitle = "Odds Ratios usando como referencia el consumo Frecuente)",
x = "Odds Ratio", y = NULL,
caption = "Nota: Estimación svyglm ponderada. Panel 1 muestra efecto estructural. Panel 2 muestra selección adversa."
) +
theme_bw() +
theme(
axis.text.y = element_text(face = "bold", size = 11),
strip.text = element_text(face = "bold", size = 11, color = "white", hjust = 0.5), # Centrado
strip.background = element_rect(fill = "#2c3e50"),
legend.position = "none",
panel.grid.minor = element_blank(),
panel.spacing = unit(1, "lines")
)
print(p_forest_concept)
ggsave("Graficos-tablas/bivariado_forest_conceptual_multivariado.png", p_forest_concept, width = 11, height = 8)
# Preparación de datos para el Forest Plot
# Clasificamos los coeficientes según el mecanismo económico/epidemiológico
df_forest_conceptual <- tabla_resultados %>%
filter(term == "Mujer" | grepl("Consumo", term)) %>%
filter(!grepl("Edad", term)) %>% # Filtramos interacciones de edad para limpieza visual
mutate(
Mecanismo = case_when(
grepl("Diario", term) & !grepl("Mujer", term) ~ "1. Efecto tratamiento (margen intensivo)",
(grepl("No consume", term) | grepl("Ocasional", term)) & !grepl("Mujer", term) ~ "2. Sesgo de endogeneidad (causalidad reversa)",
term == "Mujer" ~ "3. Control de heterogeneidad (sexo)",
TRUE ~ "Otros"
),
term_clean = case_when(
grepl("Diario", term) ~ "Consumo diario (intensificación)",
grepl("Ocasional", term) ~ "Consumo ocasional (reducción)",
grepl("No consume", term) ~ "No consume (abstinencia)",
term == "Mujer" ~ "Ser mujer (vs hombre)",
TRUE ~ term
)
) %>%
filter(Mecanismo != "Otros") %>%
filter(!grepl("Mujer", term) | term == "Mujer")
# B) Generación del Gráfico
p_forest_concept <- ggplot(df_forest_conceptual,
aes(x = estimate, y = reorder(term_clean, estimate), color = Mecanismo)) +
geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.3, size = 0.8) +
geom_point(size = 4) +
geom_text(aes(label = paste0("OR: ", estimate)), vjust = -1.5, size = 3.5, fontface = "bold") +
# Facetas con títulos centrados arriba
facet_wrap(~Mecanismo, ncol = 1, scales = "free_y") +
scale_x_log10() +
scale_color_manual(values = c(
"1. Efecto tratamiento (margen intensivo)" = "#D62728",
"2. Sesgo de endogeneidad (causalidad reversa)" = "#FF7F0E",
"3. Control de heterogeneidad (sexo)" = "#1F77B4"
)) +
labs(
title = "Identificación del efecto del consumo de azúcar",
subtitle = "Odds Ratios usando como referencia el consumo Frecuente",
x = "Odds Ratio", y = NULL,
caption = "Nota: Estimación svyglm ponderada. Panel 1 muestra efecto estructural. Panel 2 muestra selección adversa."
) +
theme_bw() +
theme(
axis.text.y = element_text(face = "bold", size = 11),
strip.text = element_text(face = "bold", size = 11, color = "white", hjust = 0.5), # Centrado
strip.background = element_rect(fill = "#2c3e50"),
legend.position = "none",
panel.grid.minor = element_blank(),
panel.spacing = unit(1, "lines")
)
print(p_forest_concept)
ggsave("Graficos-tablas/bivariado_forest_conceptual_multivariado.png", p_forest_concept, width = 11, height = 8)
gc()
